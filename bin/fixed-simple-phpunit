#!/usr/bin/env php
<?php

error_reporting(-1);

global $argv, $argc;

$argv = isset($_SERVER['argv']) ? $_SERVER['argv'] : array();
$cmd = array_map('escapeshellarg', $argv);

$phpUnitConfigFiles = loadPhpConfigFiles();

$PHP_BINARY = defined('PHP_BINARY') ? PHP_BINARY : 'php';
$runningProcs = array();
$exit = 0;

array_splice($argv, 1, 0, array('--colors=always'));

$phpUnitVersion = null;
$phpUnitConfigFile = null;

if (1 === count($phpUnitConfigFiles)) {
    // When only one phpunit config file run it directly in current process for streamed output
    $phpUnitConfigFile = reset($phpUnitConfigFiles);
    $phpUnitVersion = getPhpUnitVersion($phpUnitConfigFile);
    removePhpUnitDependencyConflicts($phpUnitConfigFile, $phpUnitVersion);
    $argv[] = '-c';
    $argv[] = $phpUnitConfigFile;
} else {
    unset($argv[0]);

    foreach ($phpUnitConfigFiles as $phpUnitConfigFile) {
        $phpUnitVersion = getPhpUnitVersion($phpUnitConfigFile);
        removePhpUnitDependencyConflicts($phpUnitConfigFile, $phpUnitVersion);

        $phpUnit = getPhpUnit($phpUnitVersion, $phpUnitConfigFile);
        $folder = dirname($phpUnitConfigFile);

        $cmd = sprintf('%s %s -c %s %s --colors=always > %s/phpunit.stdout 2> %s/phpunit.stderr',
            escapeshellcmd($PHP_BINARY),
            escapeshellcmd($phpUnit),
            escapeshellarg($phpUnitConfigFile),
            implode(' ', array_map('escapeshellarg', $argv)),
            escapeshellarg($folder),
            escapeshellarg($folder)
        );

        if ($proc = proc_open($cmd, array(), $pipes)) {
            $runningProcs[$folder] = $proc;
        } else {
            $exit = 1;
            echo "\033[41mKO\033[0m $folder\n\n";
        }
    }
}

if (count($runningProcs)) {
    $exit = runProcs($runningProcs);
} else {
    if (!class_exists('SymfonyBlacklistSimplePhpunit', false)) {
        class SymfonyBlacklistSimplePhpunit {}
    }

    $_SERVER['argv'] = $argv;
    $_SERVER['argc'] = ++$argc;
    include getPhpUnit($phpUnitVersion, $phpUnitConfigFile);
}

exit($exit);

// ----------------------------------------------------------
// ----------------------------------------------------------
// ----------------------------------------------------------

function runProcs($runningProcs)
{
    $exit = 0;

    while ($runningProcs) {
        usleep(300000);
        $terminatedProcs = array();
        foreach ($runningProcs as $component => $proc) {
            $procStatus = proc_get_status($proc);
            if (!$procStatus['running']) {
                $terminatedProcs[$component] = $procStatus['exitcode'];
                unset($runningProcs[$component]);
                proc_close($proc);
            }
        }

        foreach ($terminatedProcs as $component => $procStatus) {
            foreach (array('out', 'err') as $file) {
                $file = "$component/phpunit.std$file";
                readfile($file);
                unlink($file);
            }

            // Fail on any individual component failures but ignore some error codes on Windows when APCu is enabled:
            // STATUS_STACK_BUFFER_OVERRUN (-1073740791/0xC0000409)
            // STATUS_ACCESS_VIOLATION (-1073741819/0xC0000005)
            // STATUS_HEAP_CORRUPTION (-1073740940/0xC0000374)
            if ($procStatus && ('\\' !== DIRECTORY_SEPARATOR || !extension_loaded('apcu') || !ini_get('apc.enable_cli') || !in_array($procStatus, array(-1073740791, -1073741819, -1073740940)))) {
                $exit = $procStatus;
                echo "\033[41mKO\033[0m $component\n\n";
            } else {
                echo "\033[32mOK\033[0m $component\n\n";
            }
        }
    }

    return $exit;
}

function getPhpUnit($phpUnitVersion = null, $phpUnitConfigFile = null)
{
    if (null === $phpUnitVersion) {
        $phpUnitVersion = getPhpUnitVersion($phpUnitConfigFile);
    }

    $PHPUNIT_DIR = getEnvVar($phpUnitConfigFile, 'SYMFONY_PHPUNIT_DIR', getRootDirectory().'/vendor/bin/.phpunit');

    $phpUnit = $PHPUNIT_DIR . '/phpunit-' . $phpUnitVersion . '/phpunit';

    if (!file_exists($phpUnit)) {
        loadPhpUnit($phpUnitVersion, $phpUnit);
    }

    return $phpUnit;
}

function loadPhpUnit($phpUnitVersion, $phpUnit)
{
    // TODO load php unit like

}

function removePhpUnitDependencyConflicts($phpUnitConfigFile, $phpUnitVersion)
{
    if ($SYMFONY_PHPUNIT_REMOVE = getEnvVar($phpUnitConfigFile, 'SYMFONY_PHPUNIT_REMOVE')) {
        // TODO remove composer conflicted dependencies
    }
}

function getRootDirectory()
{
    static $root;

    if (!$root) {
        // Go the folders up until find a composer.json file
        $root = __DIR__;
        while (!file_exists($root.'/composer.json') || file_exists($root.'/DeprecationErrorHandler.php')) {
            if ($root === dirname($root)) {
                break;
            }
            $root = dirname($root);
        }
    }

    return $root;
}

function getPhpUnitVersion($phpUnitConfigFile = null)
{
    if (PHP_VERSION_ID >= 70200) {
        // PHPUnit 6 is required for PHP 7.2+
        $PHPUNIT_VERSION = getEnvVar($phpUnitConfigFile, 'SYMFONY_PHPUNIT_VERSION', '6.5');
    } elseif (PHP_VERSION_ID >= 50600) {
        // PHPUnit 4 does not support PHP 7
        $PHPUNIT_VERSION = getEnvVar($phpUnitConfigFile, 'SYMFONY_PHPUNIT_VERSION', '5.7');
    } else {
        // PHPUnit 5.1 requires PHP 5.6+
        $PHPUNIT_VERSION = '4.8';
    }

    return $PHPUNIT_VERSION;
}

function getEnvVar($phpUnitConfigFile, $name, $default = false)
{
    // Search first for given env variables
    if (false !== $value = getenv($name)) {
        return $value;
    }

    if (file_exists($phpUnitConfigFile)) {
        // Load phpunit config files and search for the env variable
        $phpunitConfig = new DomDocument();
        $phpunitConfig->load($phpUnitConfigFile);

        $var = new DOMXpath($phpunitConfig);
        foreach ($var->query('//php/env[@name="'.$name.'"]') as $var) {
            return $var->getAttribute('value');
        }
    }

    return $default;
}

function loadPhpConfigFiles() {
    global $argv;

    $phpUnitConfigFiles = [];

    // Use configuration file current folder when no arguments given
    if (!isset($argv[1])) {
        if (file_exists('phpunit.xml')) {
            $phpUnitConfigFiles[] = realpath('phpunit.xml');
        } elseif (file_exists('phpunit.xml.dist')) {
            $phpUnitConfigFiles[] = realpath('phpunit.xml.dist');
        } else {
            outputError('No phpunit.xml.dist file found!');
        }

        return $phpUnitConfigFiles;
    }

    // Use config file when given it over -c argument
    if (($configArgumentNr = array_search('-c', $argv))
        || ($configArgumentNr = array_search('--cconfiguration', $argv)))
    {
        ++$configArgumentNr;

        if (!isset($argv[$configArgumentNr])) {
            outputError('Please provide a configuration file when using "-c" argument!');

            exit(1);
        }

        $phpUnitConfigFiles[] = realpath($argv[$configArgumentNr]);

        // following arguments are given manully to the phpunit process
        unset($argv[$configArgumentNr]);
        unset($argv[$configArgumentNr - 1]);

        return $phpUnitConfigFiles;
    }

    if (isset($argv[1]) && 'symfony' === $argv[1] && !file_exists('symfony') && file_exists('src/Symfony')) {
        // If symfony if given set the folder to src/Symfony
        $argv[1] = 'src/Symfony';
    }

    // Find all config file when folder given
    if (is_dir($argv[1])) {
        $finder = new RecursiveDirectoryIterator($argv[1], FilesystemIterator::KEY_AS_FILENAME | FilesystemIterator::UNIX_PATHS);
        $finder = new RecursiveIteratorIterator($finder);
        $finder->setMaxDepth(getenv('SYMFONY_PHPUNIT_MAX_DEPTH') ?: 3);

        foreach ($finder as $file => $fileInfo) {
            // Prefer phpunit.xml over phpunit.xml.dist file
            $folder = dirname($fileInfo->getPathname());
            if ('phpunit.xml.dist' === $file && !isset($phpUnitConfigFiles[$folder])) {
                $phpUnitConfigFiles[$folder] = realpath($fileInfo->getPathname());
            } elseif ('phpunit.xml' === $file) {
                $phpUnitConfigFiles[$folder] = realpath($fileInfo->getPathname());
            }
        }

        ksort($phpUnitConfigFiles);

        array_values($phpUnitConfigFiles);

        if (0 === count($phpUnitConfigFiles)) {
            outputError('No configuration files found in: ' . getcwd() . $argv[1]);
        }

        unset($argv[1]); // $argv[1] should not provided to phpunit process
    } elseif(file_exists($argv[1])) {
        $phpUnitConfigFiles[] = $argv[1];

        unset($argv[1]); // $argv[1] should not provided to phpunit process
    }

    return $phpUnitConfigFiles;
}

function outputError($text, $exitCode = 1)
{
    echo "\033[41m" . $text . "\033[0m" . PHP_EOL;

    exit($exitCode);
}
